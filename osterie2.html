<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista Articoli · Minimal V2</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafaf7; --card:#ffffff; --ink:#111; --muted:#646464; --line:#eae6dc; --brand:#0b5;
      --warn:#b00020; --warnbg:#fee; --ok:#0a7d20;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{max-width:900px;margin:0 auto;padding:18px 14px 10px;text-align:center}
    h1{font-family:"Playfair Display",serif;font-weight:600;margin:0 0 4px 0;font-size:24px;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .search{flex:1;max-width:520px}
    .search input{width:100%;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--brand);outline:none}
    .search input::placeholder{color:#0b5600b3}
    .count{font-size:12px;color:var(--brand);margin-top:6px}
    .container{max-width:900px;margin:8px auto 20px;padding:0 12px}
    .list{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:12px;background:var(--card);overflow:hidden}
    .row{display:grid;grid-template-columns:26px 1fr max-content;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .row:last-child{border-bottom:none}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);justify-self:center}
    .title{font-weight:600;margin:0 0 2px 0}
    .meta{color:var(--muted);font-size:12px;margin:0}
    .price{font-weight:700}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:#333;background:#fafaf9;margin-left:6px}
    footer{max-width:900px;margin:10px auto 24px;padding:0 12px;color:#4a4a4a;font-size:12px}
    .alert{border-radius:10px;padding:10px 12px;margin:10px auto;max-width:900px}
    .alert.warn{color:var(--warn);background:var(--warnbg);border:1px solid #f4caca}
    .alert.info{color:#234; background:#eef5ff; border:1px solid #cfe2ff}
    .alert.ok{color:#0a5c19;background:#eaf8ed;border:1px solid #cdebd4}
    .hide{display:none}
    button{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600}
    @media (max-width:560px){
      .row{grid-template-columns:22px 1fr;grid-template-rows:auto auto;gap:8px}
      .price{grid-column:2;justify-self:end}
    }
  </style>
</head>
<body>
  <header>
    <h1>Lista Articoli</h1>
    <div class="sub">Sorgente: file Excel. Ricerca istantanea.</div>
    <div class="tools">
      <div class="search"><input id="q" placeholder="Cerca per nome, unità, confezione…"></div>
    </div>
    <div id="count" class="count"></div>
  </header>

  <div id="status" class="alert info hide">Pronto. Seleziona un file Excel e premi “Carica”.</div>

  <div class="container">
    <div id="list" class="list" role="list"></div>
  </div>

  <footer>
    <div class="tools" style="margin-top:10px">
      <input id="filePicker" type="file" accept=".xlsx,.xls" />
      <button id="btnLoad" disabled>Carica</button>
    </div>
    <div class="sub" style="text-align:center;margin-top:6px">
      Suggerimento: su GitHub Pages i file .xlsx non possono essere pre‑caricati via URL. Usa il pulsante sopra, oppure pubblica un JSON statico.
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const filePicker = document.getElementById('filePicker');
    const btnLoad = document.getElementById('btnLoad');
    let ITEMS = [];

    function showStatus(type, msg){
      statusEl.className = 'alert ' + type;
      statusEl.textContent = msg;
      statusEl.classList.remove('hide');
    }

    function asCurrency(x){
      if(x===undefined || x===null || x==='') return '';
      const n = Number(String(x).replace(/[^\d,.-]/g,'').replace('.','').replace(',', '.'));
      if (isNaN(n)) return String(x);
      try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n); }
      catch(e){ return String(x); }
    }

    function findHeaderRow(arr){
      // Heuristica: prima riga in cui col B è testo non vuoto e col F è numero o stringa numerica
      for(let i=0;i<Math.min(arr.length,30);i++){
        const b = arr[i][1], f = arr[i][5];
        const fnum = Number(String(f).replace(/[^\d,.-]/g,'').replace('.','').replace(',', '.'));
        if(typeof b === 'string' && b.trim() && !isNaN(fnum)) return i;
      }
      return 0;
    }

    function parseSheet(ws){
      const data = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:null});
      if(!data.length) return [];
      const start = findHeaderRow(data);
      const out = [];
      for(let r=start; r<data.length; r++){
        const row = data[r] || [];
        const name = row[1];     // B
        const conf = row[2];     // C
        const unit = row[3];     // D
        const pack = row[4];     // E
        const priceRaw = row[5]; // F
        const price = Number(String(priceRaw).replace(/[^\d,.-]/g,'').replace('.','').replace(',', '.'));
        if(typeof name === 'string' && name.trim() && !isNaN(price)){
          out.push({
            id: name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''),
            name: name.trim(),
            conf: conf && String(conf).trim() || '',
            unit: unit && String(unit).trim() || '',
            pack: pack && String(pack).trim() || '',
            price: price
          });
        }
      }
      out.sort((a,b)=>a.name.localeCompare(b.name,'it'));
      return out;
    }

    function rowTemplate(p){
      const metaParts = [];
      if(p.unit) metaParts.push(p.unit);
      if(p.pack) metaParts.push('x ' + p.pack);
      if(p.conf) metaParts.push(p.conf);
      const meta = metaParts.join(' · ');
      return `<div class="row" role="listitem">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div class="title">${p.name}</div>
          <p class="meta">${meta ? meta : ''}</p>
        </div>
        <div class="price">${asCurrency(p.price)}</div>
      </div>`;
    }

    function render(list){
      if(!list || list.length===0){
        listEl.innerHTML = '<div class="row"><div class="dot"></div><div class="meta">Nessun risultato</div></div>';
        countEl.textContent = '0 risultati';
        return;
      }
      listEl.innerHTML = list.map(rowTemplate).join('');
      countEl.textContent = list.length + (list.length===1 ? ' articolo' : ' articoli');
    }

    function filter(term){
      const t = term.trim().toLowerCase();
      if(!t) return ITEMS;
      return ITEMS.filter(p => {
        const hay = [p.name, p.unit, p.pack, p.conf].join(' ').toLowerCase();
        return hay.includes(t);
      });
    }

    qEl.addEventListener('input', () => render(filter(qEl.value)));

    function loadFromFile(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const wb = XLSX.read(e.target.result, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            resolve(parseSheet(ws));
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    filePicker.addEventListener('change', () => {
      btnLoad.disabled = !filePicker.files || filePicker.files.length === 0;
      if (filePicker.files && filePicker.files[0]){
        showStatus('info', 'File selezionato: ' + filePicker.files[0].name + '. Premi “Carica”.');
      }
    });

    btnLoad.addEventListener('click', async () => {
      const f = filePicker.files && filePicker.files[0];
      if(!f){ showStatus('warn','Nessun file selezionato.'); return; }
      try{
        showStatus('info', 'Caricamento in corso…');
        ITEMS = await loadFromFile(f);
        render(ITEMS);
        qEl.value = '';
        showStatus('ok', 'File caricato. ' + ITEMS.length + ' articoli trovati.');
      }catch(err){
        showStatus('warn', 'Errore nel leggere il file: ' + err.message);
      }
    });

    // Stato iniziale
    render([]);
    showStatus('info','Pronto. Seleziona un file e premi “Carica”.');
  </script>
</body>
</html>
