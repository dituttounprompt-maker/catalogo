<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stampa Ristoranti da Excel</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
<style>
  :root { --fg:#111; --bg:#fafafa; --accent:#0b7; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;z-index:2}
  header h1{margin:0 0 8px 0;font-size:18px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  input[type=file], select, button{padding:8px 10px;font-size:14px}
  button{cursor:pointer;border:1px solid #ccc;background:#fff}
  button.primary{border-color:var(--accent);color:#fff;background:var(--accent)}
  .hint{font-size:12px;color:#555}
  main{padding:16px;max-width:920px;margin:auto}
  #list{display:grid;gap:8px}
  .name-chip{padding:8px 10px;border:1px dashed #ccc;background:#fff}
  /* Pagine di stampa */
  #pages{margin-top:16px}
  .page{display:flex;align-items:center;justify-content:center;height:100vh;background:#fff;border:1px solid #eee;margin:8px 0}
  .title{font-size:72px;font-weight:700;text-align:center;word-break:break-word;padding:0 24px}
  @media print{
    header,.hint,.screen-only{display:none !important}
    body{background:#fff}
    @page{size:A4;margin:15mm}
    .page{border:none;height:auto;min-height:257mm;page-break-after:always;margin:0}
    .title{font-size:72pt}
  }
</style>
</head>
<body>
<header class="screen-only">
  <h1>Stampa Ristoranti da Excel</h1>
  <div class="controls">
    <input id="file" type="file" accept=".xlsx,.xls" />
    <label>Foglio: <select id="sheetSel" disabled></select></label>
    <label>Colonna nomi: <select id="colSel" disabled></select></label>
    <button id="printBtn" class="primary" disabled>Stampa</button>
  </div>
  <div class="hint">Carica un file Excel. Scegli foglio e colonna con i nomi. In stampa ogni nome va su un foglio.</div>
</header>

<main>
  <h2 class="screen-only">Anteprima elenco</h2>
  <div id="list" class="screen-only"></div>
  <div id="pages"></div>
</main>

<script>
const $ = (s)=>document.querySelector(s);
const fileInput = $("#file");
const sheetSel = $("#sheetSel");
const colSel = $("#colSel");
const printBtn = $("#printBtn");
const listDiv = $("#list");
const pagesDiv = $("#pages");

let workbook = null;
let dataBySheet = {}; // sheetName -> array of rows (array-of-arrays)

fileInput.addEventListener("change", async (e)=>{
  resetUI();
  const f = e.target.files[0];
  if(!f) return;
  const ab = await f.arrayBuffer();
  workbook = XLSX.read(ab, {type:"array"});
  // populate sheet select
  sheetSel.innerHTML = "";
  workbook.SheetNames.forEach((name, i)=>{
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    sheetSel.appendChild(opt);
  });
  sheetSel.disabled = false;
  loadSheet(sheetSel.value);
});

sheetSel.addEventListener("change", ()=> loadSheet(sheetSel.value));
colSel.addEventListener("change", ()=> renderNames());
printBtn.addEventListener("click", ()=> window.print());

function resetUI(){
  listDiv.innerHTML = "";
  pagesDiv.innerHTML = "";
  sheetSel.innerHTML = "";
  colSel.innerHTML = "";
  sheetSel.disabled = true;
  colSel.disabled = true;
  printBtn.disabled = true;
  dataBySheet = {};
}

function loadSheet(name){
  if(!workbook) return;
  if(!dataBySheet[name]){
    const ws = workbook.Sheets[name];
    // get AOAs. header:1 returns rows as arrays
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
    dataBySheet[name] = aoa;
  }
  const rows = dataBySheet[name];
  // build column selector from header row, or infer
  const header = rows[0] || [];
  const colsCount = Math.max(...rows.map(r=>r.length), 0);
  colSel.innerHTML = "";
  for(let c=0;c<colsCount;c++){
    const label = header[c] ? String(header[c]) : "Colonna " + XLSX.utils.encode_col(c);
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = label;
    colSel.appendChild(opt);
  }
  colSel.disabled = false;

  // heuristic preselect: prefer headers containing keywords
  const kw = ["nome","ristorante","name","restaurant"];
  let pick = 0;
  for(let c=0;c<colsCount;c++){
    const v = String(header[c]||"").toLowerCase();
    if(kw.some(k=>v.includes(k))){ pick = c; break; }
  }
  colSel.value = String(pick);
  renderNames();
}

function renderNames(){
  const sheet = sheetSel.value;
  const rows = dataBySheet[sheet] || [];
  const col = parseInt(colSel.value || "0", 10);
  // collect names. skip header if it looks like text header.
  let startRow = 0;
  if(rows.length && typeof rows[0][col] === "string"){
    const v = rows[0][col].toLowerCase();
    if(v.includes("nome") || v.includes("ristorante") || v.includes("restaurant") || v.includes("name")){
      startRow = 1;
    }
  }
  const names = [];
  for(let r=startRow;r<rows.length;r++){
    const cell = rows[r][col];
    const s = cell==null ? "" : String(cell).trim();
    if(s) names.push(s);
  }
  // update preview and pages
  listDiv.innerHTML = names.map(n=>`<div class="name-chip">${escapeHTML(n)}</div>`).join("");
  pagesDiv.innerHTML = names.map(n=>`<section class="page"><div class="title">${escapeHTML(n)}</div></section>`).join("");
  printBtn.disabled = names.length === 0;
}

function escapeHTML(str){
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
</script>
</body>
</html>
