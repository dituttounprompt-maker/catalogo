<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista Articoli · Minimal V3</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fafaf7; --card:#ffffff; --ink:#111; --muted:#646464; --line:#eae6dc; --brand:#0b5;
           --warn:#b00020; --warnbg:#fee; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{max-width:900px;margin:0 auto;padding:18px 14px 10px;text-align:center}
    h1{font-family:"Playfair Display",serif;font-weight:600;margin:0 0 4px 0;font-size:24px;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .search{flex:1;max-width:520px}
    .search input{width:100%;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--brand);outline:none}
    .search input::placeholder{color:#0b5600b3}
    .count{font-size:12px;color:var(--brand);margin-top:6px}
    .container{max-width:900px;margin:8px auto 20px;padding:0 12px}
    .list{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:12px;background:var(--card);overflow:hidden}
    .row{display:grid;grid-template-columns:26px 1fr max-content;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .row:last-child{border-bottom:none}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);justify-self:center}
    .title{font-weight:600;margin:0 0 2px 0}
    .meta{color:var(--muted);font-size:12px;margin:0}
    .price{font-weight:700;white-space:nowrap}
    footer{max-width:900px;margin:10px auto 24px;padding:0 12px;color:#4a4a4a;font-size:12px}
    .alert{border-radius:10px;padding:10px 12px;margin:10px auto;max-width:900px}
    .alert.warn{color:var(--warn);background:var(--warnbg);border:1px solid #f4caca}
    .alert.info{color:#234; background:#eef5ff; border:1px solid #cfe2ff}
    .alert.ok{color:#0a5c19;background:#eaf8ed;border:1px solid #cdebd4}
    .hide{display:none}
    button{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600}
    @media (max-width:560px){
      .row{grid-template-columns:22px 1fr;grid-template-rows:auto auto;gap:8px}
      .price{grid-column:2;justify-self:end}
    }
  </style>
</head>
<body>
  <header>
    <h1>Lista Articoli</h1>
    <div class="sub">Sorgente: file Excel. Ricerca istantanea.</div>
    <div class="tools">
      <div class="search"><input id="q" placeholder="Cerca per nome, unità, confezione…"></div>
    </div>
    <div id="count" class="count"></div>
  </header>

  <div id="status" class="alert info">Pronto. Seleziona un file e premi “Carica”.</div>

  <div class="container">
    <div id="list" class="list" role="list"></div>
  </div>

  <footer>
    <div class="tools" style="margin-top:10px">
      <input id="filePicker" type="file" accept=".xlsx,.xls" />
      <button id="btnLoad" disabled>Carica</button>
    </div>
    <div class="sub" style="text-align:center;margin-top:6px">
      Parsing automatico con rilevamento colonne. Se i prezzi non sono in tabella verranno lasciati vuoti.
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const filePicker = document.getElementById('filePicker');
    const btnLoad = document.getElementById('btnLoad');
    let ITEMS = [];

    function showStatus(type, msg){
      statusEl.className = 'alert ' + type;
      statusEl.textContent = msg;
      statusEl.classList.remove('hide');
    }

    function toNumberMaybe(v){
      if(v===null || v===undefined) return null;
      const s = String(v).trim();
      if(!s) return null;
      const n = Number(s.replace(/[^\d,.-]/g,'').replace(/\.(?=\d{3}(?:\D|$))/g,'').replace(',', '.'));
      return isNaN(n) ? null : n;
    }

    function asCurrencyOrBlank(n){
      if(n===null) return '';
      try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n); }
      catch(e){ return String(n); }
    }

    function normalizeHeader(s){
      return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/\./g,'');
    }

    function detectColumns(arr){
      // Cerca riga intestazione con parole chiave
      const nameKeys = ['descr','descrizione','articolo','prodotto','nome'];
      const priceKeys = ['prezzo','euro','€/kg','€/','€','listino'];
      const unitKeys = ['u.m','um','unità','unita','kg','nr','pz'];
      const packKeys = ['conf','collo','pezzi','pzxcollo','pzx','xcollo'];
      for(let r=0;r<Math.min(arr.length,30);r++){
        const row = arr[r]||[];
        const norms = row.map(normalizeHeader);
        const hasName = norms.some(h=>nameKeys.some(k=>h.includes(k)));
        const hasPrice = norms.some(h=>priceKeys.some(k=>h.includes(k)));
        if(hasName){
          const idx = {
            headerRow:r,
            name: norms.findIndex(h=>nameKeys.some(k=>h.includes(k))),
            price: norms.findIndex(h=>priceKeys.some(k=>h.includes(k))),
            unit: norms.findIndex(h=>unitKeys.some(k=>h.includes(k))),
            pack: norms.findIndex(h=>packKeys.some(k=>h.includes(k))),
          };
          return idx;
        }
      }
      // fallback: nessuna intestazione chiara
      return {headerRow:-1,name:-1,price:-1,unit:-1,pack:-1};
    }

    function inferRow(row){
      // sceglie la cella testuale più lunga come nome
      let name = '';
      let unit = '';
      let pack = '';
      let price = null;
      for(const cell of row){
        const s = String(cell||'').trim();
        if(!s) continue;
        const num = toNumberMaybe(s);
        if(num!==null){
          // potrebbe essere prezzo: salvo il più credibile (con virgola o '€')
          if((/[\d],[\d]{2}\b/.test(s) || s.includes('€')) || price===null) price = num;
          continue;
        }
        if(/^(kg|nr|pz|um)$/i.test(s)) { unit = unit || s.toUpperCase(); continue; }
        if(/^\d+([.,]\d+)?$/.test(s))  { pack = pack || s; continue; }
        // escludi pattern tipo "4x1" "1x0,380"
        if(/^\d+\s*[xX]\s*[\d,\.]+$/.test(s)) continue;
        if(s.length > name.length) name = s;
      }
      return {name:name||'', unit, pack, price};
    }

    function parseSheet(ws){
      const data = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:null});
      if(!data.length) return [];
      const col = detectColumns(data);
      const start = col.headerRow >= 0 ? col.headerRow+1 : 0;
      const out = [];
      for(let r=start; r<data.length; r++){
        const row = data[r] || [];
        let name='', unit='', pack='', price=null;
        if(col.name>=0){
          name = String(row[col.name]||'').trim();
          unit = col.unit>=0 ? String(row[col.unit]||'').trim() : '';
          pack = col.pack>=0 ? String(row[col.pack]||'').trim() : '';
          price = col.price>=0 ? toNumberMaybe(row[col.price]) : null;
        }else{
          const it = inferRow(row);
          name = it.name; unit = it.unit; pack = it.pack; price = it.price;
        }
        if(name && !/^\d+\s*[xX]\s*[\d,\.]+$/.test(name)){
          out.push({
            id: name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''),
            name, unit, pack, price
          });
        }
      }
      // dedup per nome e ordina
      const seen = new Set();
      const dedup = [];
      for(const p of out){
        const key = p.name.toLowerCase();
        if(!seen.has(key)){ seen.add(key); dedup.push(p); }
      }
      dedup.sort((a,b)=>a.name.localeCompare(b.name,'it'));
      return dedup;
    }

    function rowTemplate(p){
      const metaParts = [];
      if(p.unit) metaParts.push(p.unit);
      if(p.pack) metaParts.push('x ' + p.pack);
      const meta = metaParts.join(' · ');
      const priceHtml = p.price===null ? '' : asCurrencyOrBlank(p.price);
      return `<div class="row" role="listitem">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div class="title">${p.name}</div>
          <p class="meta">${meta}</p>
        </div>
        <div class="price">${priceHtml}</div>
      </div>`;
    }

    function render(list){
      if(!list || list.length===0){
        listEl.innerHTML = '<div class="row"><div class="dot"></div><div class="meta">Nessun risultato</div></div>';
        countEl.textContent = '0 risultati';
        return;
      }
      listEl.innerHTML = list.map(rowTemplate).join('');
      countEl.textContent = list.length + (list.length===1 ? ' articolo' : ' articoli');
    }

    function filter(term){
      const t = term.trim().toLowerCase();
      if(!t) return ITEMS;
      return ITEMS.filter(p => {
        const hay = [p.name, p.unit, p.pack].join(' ').toLowerCase();
        return hay.includes(t);
      });
    }

    qEl.addEventListener('input', () => render(filter(qEl.value)));

    function loadFromFile(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const wb = XLSX.read(e.target.result, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            resolve(parseSheet(ws));
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    filePicker.addEventListener('change', () => {
      btnLoad.disabled = !filePicker.files || filePicker.files.length === 0;
    });

    btnLoad.addEventListener('click', async () => {
      const f = filePicker.files && filePicker.files[0];
      if(!f){ showStatus('warn','Nessun file selezionato.'); return; }
      try{
        showStatus('info', 'Caricamento in corso…');
        ITEMS = await loadFromFile(f);
        render(ITEMS);
        qEl.value = '';
        showStatus('ok', 'File caricato. ' + ITEMS.length + ' articoli trovati.');
      }catch(err){
        showStatus('warn', 'Errore nel leggere il file: ' + err.message);
      }
    });

    // init
    render([]);
  </script>
</body>
</html>
